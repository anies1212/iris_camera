name: release-prepare

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 0.1.0)'
        required: true
        type: string

jobs:
  open-release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # 5.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Validate version input
        id: version
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[A-Za-z0-9.-]+)?$ ]]; then
            echo "Version must follow semver (e.g. 1.2.3 or 1.2.3-rc.1)" >&2
            exit 1
          fi
          echo "value=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Update pubspec version
        run: |
          version="${{ steps.version.outputs.value }}"
          perl -0pi -e "s/^version:\s*.*/version: $version/m" pubspec.yaml

      - name: Collect release context
        id: context
        run: |
          git fetch --tags
          prev_tag=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || true)
          range="${prev_tag:+$prev_tag..HEAD}"
          commits=$(git log --no-merges --pretty='- %s (%h)' ${range:+$range})

          echo "prev-tag=$prev_tag" >> "$GITHUB_OUTPUT"
          {
            echo "commits<<EOF"
            printf '%s\n' "$commits"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build changelog prompt
        id: prompt
        run: |
          version="${{ steps.version.outputs.value }}"
          prev_tag="${{ steps.context.outputs.prev-tag }}"
          commits="${{ steps.context.outputs.commits }}"

          {
            cat .github/prompts/release_changelog_prompt.txt
            echo ""
            echo "Version: $version"
            if [[ -n "$prev_tag" ]]; then
              echo "Previous tag: $prev_tag"
            fi
            echo "Commits:"
            printf '%s\n' "$commits"
          } > prompt.txt

          prompt_json=$(jq -Rs . < prompt.txt)
          echo "prompt=$prompt_json" >> "$GITHUB_OUTPUT"

      - name: Generate changelog with GitHub Models
        id: changelog
        uses: actions/ai-inference@a1c11829223a786afe3b5663db904a3aa1eac3a2 # v2.0.1
        with:
          model: gpt-4o-mini
          system-prompt: You write terse release notes.
          prompt: ${{ steps.prompt.outputs.prompt }}
          token: ${{ secrets.IRIS_AI_MODEL_SECRETS }}

      - name: Write changelog file
        id: notes
        run: |
          content="${{ steps.changelog.outputs.response }}"
          if [[ -z "$content" || "$content" == "null" ]]; then
            content="${{ steps.changelog.outputs.result }}"
          fi
          if [[ -z "$content" || "$content" == "null" ]]; then
            content="${{ steps.changelog.outputs.choices_0_message_content }}"
          fi
          if [[ -z "$content" || "$content" == "null" ]]; then
            echo "AI generation empty; falling back to commit list" >&2
            content=$(printf '%s\n' "${{ steps.context.outputs.commits }}")
          fi

          header="## ${{ steps.version.outputs.value }}"
          new_section=$(printf '%s\n\n%s\n\n' "$header" "$content")

          if [[ -f CHANGELOG.md ]]; then
            cp CHANGELOG.md CHANGELOG.prev
            {
              printf '%s\n' "$new_section"
              echo ""
              cat CHANGELOG.prev
            } > CHANGELOG.md
            rm -f CHANGELOG.prev
          else
            printf '%s\n' "$new_section" > CHANGELOG.md
          fi
          {
            echo "Prepare release ${{ steps.version.outputs.value }}."
            echo ""
            echo "- Bump package version in pubspec.yaml."
            echo ""
            echo "Changelog:"
            echo ""
            printf '%s\n\n%s\n' "$new_section"
          } > release_pr_body.md

          echo "body-path=release_pr_body.md" >> "$GITHUB_OUTPUT"

      - name: Create release branch pull request
        uses: peter-evans/create-pull-request@6d6857d36972b65feb161a90e484f2984215f83e # v6.1.0
        with:
          token: ${{ secrets.IRIS_APP_SECRETS }}
          branch: release/${{ steps.version.outputs.value }}
          delete-branch: false
          commit-message: "chore: prepare release ${{ steps.version.outputs.value }}"
          title: "release: bump up app version to ${{ steps.version.outputs.value }}"
          body-path: ${{ steps.notes.outputs.body-path }}
          add-paths: |
            pubspec.yaml
            CHANGELOG.md
